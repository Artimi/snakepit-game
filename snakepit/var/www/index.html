<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Snakepit</title>
  <link rel="stylesheet" type="text/css" href="static/css/style.css" />
  <script type="text/javascript" src="static/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript">
    var ws;
    var gameSettings;
    var playerName;
    var playerId;
    var frameId;
    var speed;
    var latency;
    var lastLatency = 0;
    var lastPing = null;
    var pingPongTimer = null;

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function sendMessage(msgArray) {
        var msg = JSON.stringify(msgArray);
        ws.send(msg);
    }

    function pingPong() {
        var currentTime;

        if (ws && !lastPing) {
            currentTime = new Date().getTime();
            sendMessage(['ping', currentTime, lastLatency]);
            lastPing = currentTime;
        }
    }

    function openHandler(){
        $('#status').html(
            'connected to server | ' +
            'speed: <span id="speed"></span><span id="speedMax"></span> | ' +
            'frame: <span id="frameId"></span><span id="frameIdMax"></span> | ' +
            'latency: <span id="latency">?</span> ms'
        );
        playerName = $('#playerName').val();
        frameId = $('#frameId');
        speed = $('#speed');
        latency = $('#latency');

        sendMessage(["new_player", playerName]);

        $('#mainScreen').hide();
        $('#version').hide();
        $('#playScreen').show();
        $('#btnJoin').show();

        $(document).bind('keydown', keyPress);

        pingPongTimer = setInterval(pingPong, 1000)
    }

    function closeHandler(){
        if (pingPongTimer) {
            clearInterval(pingPongTimer);
        }

        $('#status').text("disconnected from server");
    }

    function messageHandler(e){
        var data = JSON.parse(e.data);

        if (!(data[0] instanceof Array)) {
            data = [data];
        }

        var i = data.length;

        while (i--) {
            var args = data[i];
            var cmd = data[i][0];

            switch (cmd) {
                case('render'):
                    var cell_id = '#cell' + args[2] + '_' + args[1];
                    var symbol = args[3];
                    if (symbol === ' ') {
                        symbol = '&nbsp;';
                    }
                    $(cell_id).html(symbol);
                    $(cell_id).attr('class', 'color' + args[4]);
                    break;
                case('sync'):
                    frameId.text(args[1]);
                    speed.text(args[2]);
                    break;
                case('pong'):
                    if (lastPing === args[1]) {
                        lastLatency = new Date().getTime() - lastPing;
                        latency.text(lastLatency);
                        lastPing = null;
                    }
                    break;
                case('handshake'):
                    $('#username').text(args[1]);
                    playerId = args[2];
                    gameSettings = args[3];
                    // noinspection JSUnresolvedVariable
                    if (gameSettings.GAME_SPEED_MAX) {
                        // noinspection JSUnresolvedVariable
                        $('#speedMax').text('/' + gameSettings.GAME_SPEED_MAX)
                    }
                    // noinspection JSUnresolvedVariable
                    if (gameSettings.GAME_FRAMES_MAX) {
                        // noinspection JSUnresolvedVariable
                        $('#frameIdMax').text('/' + gameSettings.GAME_FRAMES_MAX)
                    }
                    break;
                case('world'):
                    initWorld(args[1]);
                    break;
                case('error'):
                    alert(args[1]);
                    break;
                case('reset_world'):
                    resetWorld();
                    break;
                case('p_joined'):
                    var id = args[1];
                    var name = args[2];
                    var color = args[3];
                    var score = args[4];
                    addPlayer(id, color, name, score);
                    if (id === playerId) {
                        $('#btnJoin').hide();
                    }
                    break;
                case('p_gameover'):
                    id = args[1];
                    $('#player' + id).remove();
                    if (id === playerId) {
                        $('#btnJoin').show();
                    }
                    break;
                case('p_score'):
                    id = args[1];
                    score = args[2];
                    $('#player' + id + ' .score').text(score);
                    break;
                case('top_scores'):
                    $('#topScoresList').empty();
                    var players = args[1];
                    for (var n = 0; n < players.length; n++) {
                        name = players[n][0];
                        score = players[n][1];
                        color = players[n][2];
                        addTopScore(color, name, score);
                    }
                    break;
                default:
                    console.log('Unknown message', args);
                    break;
            }
        }
    }

    function initWorld(data) {
        var rows = [];

        for (var y = 0; y < data.length; y++){
            var row = '';

            for (var x = 0; x < data[y].length; x++){
                var symbol = data[y][x][0];
                var color = data[y][x][1];

                if (symbol === ' ') {
                    symbol = '&nbsp;';
                }

                row += '<td id="cell' + y + '_' + x + '" class="color' + color + '">' + symbol + '</td>';
            }

            rows.push("<tr>" + row + "</tr>");
        }
        var tableContent = rows.join('\n');

        $('#world').html(tableContent);
    }

    function resetWorld() {
        // noinspection JSJQueryEfficiency
        $('#world td').html('&nbsp;');
    }

    function addPlayer(id, color, name, score) {
        var color_class = 'color' + color;

        $('#activePlayersList').append('<div id="player' + id + '">'
                        + '<div class="name ' + color_class +'">' + name + '</div>'
                        + '<div class="score ' + color_class + '">' + score + '</div></div>');
    }

    function addTopScore(color, name, score) {
        var color_class = 'color' + color;

        $('#topScoresList').append('<div>'
                        + '<div class="name ' + color_class +'">' + name + '</div>'
                        + '<div class="score ' + color_class + '">' + score + '</div></div>');
    }

    function keyHandler(event, code) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(code);
            event.preventDefault();
        } else {
            $('#status').text("Connection is closed");
        }
    }

    function keyPress(event) {
        var code = event.code || event.keyCode || event.charCode;

        switch(code) {
            case('ArrowUp'):
            case('KeyW'):
            case(87):  // w
                code = 38; break;
            case('ArrowLeft'):
            case('KeyA'):
            case(65):  // a
                code = 37; break;
            case('ArrowRight'):
            case('KeyD'):
            case(68):  // d
                code = 39; break;
            case('ArrowDown'):
            case('KeyS'):
            case(83):  // s
                code = 40; break;
            case(37):
            case(38):
            case(39):
            case(40):
                break;
            case('Enter'):
            case(13):  // Enter
                // noinspection JSJQueryEfficiency
                if ($('#btnJoin').is(':visible')) {
                    $('#btnJoin').click();
                }
                return;
            case('Escape'):
            case(27):  // Esc
                // noinspection JSJQueryEfficiency
                if ($('#btnDisconnect').is(':visible')) {
                    $('#btnDisconnect').click();
                }
                return;
            default:
                return;
        }

        keyHandler(event, code);
    }

    function connect(event) {
        event.preventDefault();

        var _playerName = $('#playerName').val().trim();

        if (!_playerName.length) {
            return;
        }

        $('#status').text("connecting...");
        var url = location.pathname.substring(0, location.pathname.indexOf('/index.html')) + '/connect';
        ws = new WebSocket(((location.protocol === 'https:') ? 'wss://' : 'ws://') + location.host + url);
        ws.onopen = openHandler;
        ws.onmessage = messageHandler;
        ws.onclose = closeHandler;
        ws.onerror = function(e) {
            $('#status').text(e.toString());
        };
    }

    function disconnect(event) {
        event.preventDefault();

        if (ws) {
            ws.close();
        }

        $('#playScreen').hide();
        $('#mainScreen').show();
        $('#activePlayersList').empty();
        $('#version').show();
        $(document).unbind('keypress', keyPress);
        $('#playerName').focus()
    }

    function join(event) {
        event.preventDefault();
        sendMessage(['join']);
    }

    $().ready(function() {
        var auto_connect = getParameterByName('connect');

        // noinspection JSJQueryEfficiency
        $('#btnConnect').click(connect);
        $('#btnDisconnect').click(disconnect);
        $('#btnJoin').click(join);
        // noinspection JSUnresolvedFunction,JSJQueryEfficiency
        $('#playerName').focus().keyup(function(event) {
           var code = event.code || event.keyCode || event.charCode;

           if (code === 13 || code === 'Enter') {
               $('#btnConnect').click();
           }
        });
        if (auto_connect) {
            $('#playerName').val(auto_connect);
            $('#btnConnect').click();
        }
    });
</script>
</head>
<body>
<h1 id="title">Snakepit</h1>
<h3 id="version">ver 0.15</h3>

<div>
    <div id="mainScreen">
        <div id="connectForm">
            <label for="playerName" class="white">Name:</label>
            <input id="playerName" type="text" maxlength="15" />
            <button id="btnConnect">Connect</button>
        </div>

        <div id="description">
            <p><b class="white">Snakepit</b> is an open-source multiplayer snake game.</p>
            <p>It is designed as a demo of <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a> library for Python 3.5.</p>
            <p>Check out the source code at our <a href="https://github.com/pyconsk/snakepit-game">github repo</a>.</p>

            <div id="rules">
                <h3 class="red">Rules:</h3>

                <ol>
                    <li class="color2">Use arrows to control the snake.</li>
                    <li class="color3">Eat digits to grow up (score += digit).</li>
                    <li class="color4">Do not bite: stones (#), snakes, borders.</li>
                    <li class="color5">Earn points by killing other snakes (score += 1000).</li>
                    <li class="color6">Invite friends and have fun together!</li>
                </ol>
            </div>

        </div>
    </div>

    <div id="playScreen">
        <div id="userForm">
            Welcome to the server, <span id="username" class="white"></span>!
        </div>
        <div id="userButtons">
            <button id="btnJoin">Join!</button>
            <button id="btnDisconnect">Disconnect</button>
        </div>

        <div id="playField">
            <div id="activePlayers">
                <h3>Active players</h3>
                <div id="activePlayersList"></div>
            </div>
            <div id="worldHolder">
                <table id="world"></table>
            </div>
            <div id="topScores">
                <h3>Top scores</h3>
                <div id="topScoresList"></div>
            </div>
        </div>
    </div>

</div>

<div id="status">&nbsp;</div>

<!--
<footer>
    <p>Originally written by Kyrylo Subbotin. (c) 2016 7webpages.</p>
    <p>Modified for PyCon SK by Daniel Kontšek.</p>
</footer>
-->

</body>
</html>